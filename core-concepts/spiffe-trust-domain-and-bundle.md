# SPIFFE トラストドメインとバンドル

## このドキュメントの位置づけ

このドキュメントは、SPIFFEトラストドメインとバンドルの標準をインターネットコミュニティ向けに規定し、改善のための議論と提案を求めるものです。このドキュメントの配布に制限はありません。

## 要約

SPIFFEトラストドメインは、SPIFFE IDが発行される信頼領域です。SPIFFEバンドルは、トラストドメイン内で発行されたSVIDを検証するための暗号鍵のセットです。このドキュメントでは、トラストドメインとバンドルの概念、構造、管理方法について詳細に説明します。

## 目次

- [SPIFFE トラストドメインとバンドル](#spiffe-トラストドメインとバンドル)
  - [このドキュメントの位置づけ](#このドキュメントの位置づけ)
  - [要約](#要約)
  - [目次](#目次)
  - [1. はじめに](#1-はじめに)
  - [2. トラストドメイン](#2-トラストドメイン)
    - [2.1 トラストドメインの定義](#21-トラストドメインの定義)
    - [2.2 トラストドメインの命名](#22-トラストドメインの命名)
    - [2.3 トラストドメインの階層](#23-トラストドメインの階層)
  - [3. バンドル](#3-バンドル)
    - [3.1 バンドルの定義](#31-バンドルの定義)
    - [3.2 バンドルの形式](#32-バンドルの形式)
    - [3.3 バンドルの管理](#33-バンドルの管理)
  - [4. トラストドメイン間の信頼関係](#4-トラストドメイン間の信頼関係)
    - [4.1 フェデレーション](#41-フェデレーション)
    - [4.2 バンドルの交換](#42-バンドルの交換)
  - [5. セキュリティ考慮事項](#5-セキュリティ考慮事項)
  - [6. まとめ](#6-まとめ)

## 1. はじめに

SPIFFEトラストドメインとバンドルは、SPIFFEフレームワークの重要な概念です。トラストドメインは、SPIFFE IDが発行される信頼領域を定義し、バンドルは、そのトラストドメイン内で発行されたSVIDを検証するための暗号鍵のセットを提供します。

これらの概念は、分散システムにおけるサービス間の相互認証と信頼関係の確立に不可欠です。

## 2. トラストドメイン

### 2.1 トラストドメインの定義

トラストドメインは、SPIFFE IDが発行される信頼領域です。これは通常、組織の境界や環境の境界に対応します。トラストドメインは、SPIFFE IDの発行と検証のポリシーを定義します。

トラストドメインは、SPIFFE IDの一部として使用されます。例えば、`spiffe://example.com/service/frontend`のSPIFFE IDでは、`example.com`がトラストドメインです。

### 2.2 トラストドメインの命名

トラストドメインの名前は、DNS名前空間の規則に従う必要があります。これにより、トラストドメインの名前が一意であることが保証されます。

トラストドメインの名前は、大文字と小文字を区別しません。例えば、`example.com`と`EXAMPLE.COM`は同じトラストドメインとして扱われます。

### 2.3 トラストドメインの階層

トラストドメインは、階層的に構成することができます。例えば、`prod.example.com`と`staging.example.com`は、`example.com`の下位トラストドメインです。

階層的なトラストドメインを使用することで、組織は異なる環境や部門に対して異なるトラストドメインを定義できます。

## 3. バンドル

### 3.1 バンドルの定義

バンドルは、トラストドメイン内で発行されたSVIDを検証するための暗号鍵のセットです。バンドルには、トラストドメインの公開鍵が含まれています。

バンドルは、SVIDの検証に使用されます。サービスがSVIDを受け取ると、そのSVIDのトラストドメインに対応するバンドルを使用して、SVIDの署名を検証します。

### 3.2 バンドルの形式

バンドルは、以下の2つの形式で表現されます：

1. **X.509バンドル**: X.509証明書のセットとして表現されます。これは、X.509-SVIDの検証に使用されます。
2. **JWKSバンドル**: JSON Web Key Set（JWKS）として表現されます。これは、JWT-SVIDの検証に使用されます。

バンドルの形式は、使用するSVIDの種類によって異なります。

### 3.3 バンドルの管理

バンドルは、以下のような方法で管理されます：

1. **バンドルの作成**: トラストドメインの管理者は、トラストドメインの公開鍵を含むバンドルを作成します。
2. **バンドルの配布**: バンドルは、トラストドメイン内のサービスに配布されます。
3. **バンドルの更新**: 鍵のローテーションなどの理由でバンドルが更新された場合、新しいバンドルがサービスに配布されます。

バンドルの管理は、トラストドメインの管理者の責任です。

## 4. トラストドメイン間の信頼関係

### 4.1 フェデレーション

フェデレーションは、異なるトラストドメイン間で信頼関係を確立するプロセスです。フェデレーションにより、あるトラストドメインのサービスが別のトラストドメインのサービスと安全に通信できるようになります。

フェデレーションは、バンドルの交換によって実現されます。

### 4.2 バンドルの交換

バンドルの交換は、フェデレーションの重要な部分です。トラストドメインAとトラストドメインBがフェデレーションを確立するには、以下の手順を実行します：

1. トラストドメインAは、そのバンドルをトラストドメインBに提供します。
2. トラストドメインBは、そのバンドルをトラストドメインAに提供します。
3. 両方のトラストドメインは、受け取ったバンドルを検証し、保存します。

バンドルの交換が完了すると、トラストドメインAのサービスはトラストドメインBのサービスのSVIDを検証でき、その逆も可能になります。

## 5. セキュリティ考慮事項

トラストドメインとバンドルを使用する際には、以下のセキュリティ考慮事項に注意する必要があります：

- **バンドルの整合性**: バンドルは、改ざんから保護する必要があります。バンドルが改ざんされると、不正なSVIDが検証される可能性があります。
- **バンドルの配布**: バンドルは、安全な方法で配布する必要があります。不正なバンドルが配布されると、不正なSVIDが検証される可能性があります。
- **鍵のローテーション**: トラストドメインの鍵は、定期的にローテーションする必要があります。鍵が漏洩した場合、新しい鍵を生成し、バンドルを更新する必要があります。

## 6. まとめ

SPIFFEトラストドメインとバンドルは、SPIFFEフレームワークの重要な概念です。トラストドメインは、SPIFFE IDが発行される信頼領域を定義し、バンドルは、そのトラストドメイン内で発行されたSVIDを検証するための暗号鍵のセットを提供します。

トラストドメイン間のフェデレーションは、バンドルの交換によって実現されます。これにより、異なるトラストドメインのサービスが互いに安全に通信できるようになります。

トラストドメインとバンドルの適切な管理は、SPIFFEベースのシステムのセキュリティにとって重要です。
