# SPIFFE概要

## このドキュメントの位置づけ

このドキュメントは、アイデンティティフレームワーク標準をインターネットコミュニティ向けに規定し、改善のための議論と提案を求めるものです。このドキュメントの配布に制限はありません。

## 要約

現代のソフトウェアシステムは、複数のサービスが相互に通信する分散アーキテクチャに移行しています。これらのサービスは、クラウドプロバイダー、コンテナ、サーバーレスプラットフォームなど、さまざまな環境で実行されることがあります。このような環境では、サービス間の安全な通信を確保するために、強力なアイデンティティとアクセス管理が必要です。

Secure Production Identity Framework for Everyone（SPIFFE）は、異種環境や組織の境界を越えてサービスにIDをブートストラップし発行できるフレームワークの仕様を提供します。SPIFFEは、サービスアイデンティティを標準化し、サービス間の相互認証を可能にします。

## 目次

- [SPIFFE概要](#spiffe概要)
  - [このドキュメントの位置づけ](#このドキュメントの位置づけ)
  - [要約](#要約)
  - [目次](#目次)
  - [1. はじめに](#1-はじめに)
  - [2. 問題定義](#2-問題定義)
  - [3. SPIFFEアーキテクチャ](#3-spiffeアーキテクチャ)
    - [3.1 SPIFFE ID](#31-spiffe-id)
    - [3.2 SPIFFE検証可能アイデンティティドキュメント（SVID）](#32-spiffe検証可能アイデンティティドキュメントsvid)
    - [3.3 トラストドメイン](#33-トラストドメイン)
    - [3.4 ワークロードAPI](#34-ワークロードapi)
  - [4. SPIFFEの利点](#4-spiffeの利点)
  - [5. ユースケース](#5-ユースケース)
    - [5.1 マイクロサービスの相互認証](#51-マイクロサービスの相互認証)
    - [5.2 ゼロトラストアーキテクチャ](#52-ゼロトラストアーキテクチャ)
    - [5.3 クラウドネイティブアプリケーション](#53-クラウドネイティブアプリケーション)
  - [6. SPIFFEの実装](#6-spiffeの実装)
  - [7. まとめ](#7-まとめ)

## 1. はじめに

現代のソフトウェアシステムは、モノリシックアーキテクチャからマイクロサービスアーキテクチャへと進化しています。この変化により、サービス間の通信が増加し、セキュリティの課題が生じています。従来のネットワークベースのセキュリティモデルは、動的で分散化された環境では効果的ではありません。

SPIFFEは、このような課題に対処するために設計されたオープンスタンダードです。SPIFFEは、サービスアイデンティティを標準化し、サービス間の相互認証を可能にします。これにより、ネットワークの場所に関係なく、サービスが互いに安全に通信できるようになります。

## 2. 問題定義

分散システムにおけるサービス間通信のセキュリティを確保するには、以下の課題に対処する必要があります：

1. **アイデンティティの確立**: サービスは、信頼できる方法で自身のアイデンティティを確立する必要があります。
2. **相互認証**: サービスは、通信相手のアイデンティティを検証する必要があります。
3. **アクセス制御**: サービスは、認証されたアイデンティティに基づいてアクセスを制御する必要があります。
4. **環境の多様性**: サービスは、さまざまな環境（オンプレミス、クラウド、コンテナなど）で実行される可能性があります。
5. **スケーラビリティ**: アイデンティティとアクセス管理のソリューションは、大規模な分散システムに対応できる必要があります。

SPIFFEは、これらの課題に対処するために設計されています。

## 3. SPIFFEアーキテクチャ

SPIFFEアーキテクチャは、以下の主要コンポーネントで構成されています：

### 3.1 SPIFFE ID

SPIFFE IDは、サービスを一意に識別するための標準化された形式です。SPIFFE IDは、URIの形式で表現され、以下の構造を持ちます：

```
spiffe://トラストドメイン/パス
```

- **トラストドメイン**: SPIFFE IDが発行された信頼領域を示します。
- **パス**: トラストドメイン内でサービスを一意に識別するパスです。

例えば、`spiffe://example.com/service/database`は、`example.com`トラストドメイン内のデータベースサービスを識別します。

### 3.2 SPIFFE検証可能アイデンティティドキュメント（SVID）

SVIDは、サービスがそのSPIFFE IDを証明するために使用するドキュメントです。SVIDには、以下の2つの形式があります：

1. **X.509-SVID**: X.509証明書ベースのSVID。TLS通信に使用されます。
2. **JWT-SVID**: JSON Web Token（JWT）ベースのSVID。HTTPリクエストなどのアプリケーション層の認証に使用されます。

SVIDには、サービスのSPIFFE IDと、そのアイデンティティを検証するための暗号情報が含まれています。

### 3.3 トラストドメイン

トラストドメインは、SPIFFE IDが発行される信頼領域です。各トラストドメインには、そのドメイン内で発行されたSVIDを検証するための暗号鍵（トラストバンドル）があります。

トラストドメインは、組織の境界や環境の境界に対応することがあります。例えば、`prod.example.com`と`staging.example.com`は、異なる環境を表す別々のトラストドメインです。

### 3.4 ワークロードAPI

ワークロードAPIは、サービス（ワークロード）がSVIDを取得し、他のサービスのSVIDを検証するためのAPIです。ワークロードAPIは、以下の機能を提供します：

1. **SVID取得**: サービスは、ワークロードAPIを使用して自身のSVIDを取得します。
2. **トラストバンドル取得**: サービスは、他のサービスのSVIDを検証するために必要なトラストバンドルを取得します。
3. **SVID更新**: SVIDの有効期限が切れる前に、新しいSVIDを取得します。

ワークロードAPIは、サービスのアイデンティティを自動的に検証し、適切なSVIDを提供します。これにより、サービスは秘密鍵やパスワードを管理する必要がなくなります。

## 4. SPIFFEの利点

SPIFFEを採用することで、以下の利点が得られます：

1. **標準化されたアイデンティティ**: SPIFFEは、サービスアイデンティティの標準形式を提供します。
2. **環境に依存しない**: SPIFFEは、さまざまな環境（オンプレミス、クラウド、コンテナなど）で動作します。
3. **自動化**: SVIDの発行と更新が自動化されます。
4. **ゼロトラスト**: SPIFFEは、ゼロトラストセキュリティモデルの実装を支援します。
5. **相互運用性**: SPIFFEは、異なるシステムやプラットフォーム間の相互運用性を提供します。
6. **スケーラビリティ**: SPIFFEは、大規模な分散システムに対応できるように設計されています。

## 5. ユースケース

SPIFFEは、以下のようなユースケースに適しています：

### 5.1 マイクロサービスの相互認証

マイクロサービスアーキテクチャでは、多数のサービスが相互に通信します。SPIFFEを使用すると、各サービスは一意のアイデンティティを持ち、他のサービスと安全に通信できます。

例えば、ウェブサービスがデータベースサービスと通信する場合、両方のサービスはSVIDを使用して互いを認証します。これにより、不正なサービスがデータベースにアクセスすることを防ぎます。

### 5.2 ゼロトラストアーキテクチャ

ゼロトラストセキュリティモデルでは、ネットワークの場所に関係なく、すべてのアクセスを検証する必要があります。SPIFFEは、サービスアイデンティティに基づいてアクセスを制御するための基盤を提供します。

SPIFFEを使用すると、サービスは自身のアイデンティティを証明し、他のサービスのアイデンティティを検証できます。これにより、ネットワークの場所に依存せずに、アクセス制御を実施できます。

### 5.3 クラウドネイティブアプリケーション

クラウドネイティブアプリケーションは、複数のクラウドプロバイダーやオンプレミス環境にまたがって実行されることがあります。SPIFFEは、これらの異なる環境間でサービスアイデンティティを一貫して管理するための方法を提供します。

例えば、AWS上で実行されるサービスとGCP上で実行されるサービスが、SPIFFEを使用して互いを認証できます。これにより、クラウドプロバイダー固有のアイデンティティメカニズムに依存せずに、サービス間の通信を保護できます。

## 6. SPIFFEの実装

SPIFFEは、仕様とリファレンス実装の両方を提供しています。主な実装には以下のものがあります：

1. **SPIRE (SPIFFE Runtime Environment)**: SPIFFEの参照実装です。SPIREは、SVIDの発行と管理、ワークロードAPIの提供、トラストドメインの管理などの機能を提供します。

2. **Istio**: サービスメッシュプラットフォームであるIstioは、SPIFFEをサポートしており、SPIFFEアイデンティティを使用してサービス間の通信を保護します。

3. **Envoy**: プロキシサーバーであるEnvoyは、SPIFFEアイデンティティを使用したmTLS（相互TLS）をサポートしています。

4. **Consul**: サービスディスカバリとサービスメッシュプラットフォームであるConsulは、SPIFFEアイデンティティをサポートしています。

## 7. まとめ

SPIFFEは、分散システムにおけるサービスアイデンティティとアクセス管理の課題に対処するためのオープンスタンダードです。SPIFFEは、標準化されたアイデンティティ形式、検証可能なアイデンティティドキュメント、トラストドメイン、ワークロードAPIを提供します。

SPIFFEを採用することで、組織は以下の利点を得ることができます：

- サービス間の安全な通信
- 環境に依存しないアイデンティティ管理
- 自動化されたアイデンティティ発行と更新
- ゼロトラストセキュリティモデルの実装
- 異なるシステムやプラットフォーム間の相互運用性
- 大規模な分散システムへの対応

SPIFFEは、マイクロサービスアーキテクチャ、ゼロトラストセキュリティ、クラウドネイティブアプリケーションなど、現代のソフトウェアシステムのセキュリティニーズに対応するための強力なフレームワークです。
