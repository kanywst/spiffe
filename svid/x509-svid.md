# X.509 SVID

## このドキュメントの位置づけ

このドキュメントは、X.509 SPIFFE検証可能アイデンティティドキュメント（X.509-SVID）の標準をインターネットコミュニティ向けに規定し、改善のための議論と提案を求めるものです。このドキュメントの配布に制限はありません。

## 要約

X.509-SVIDは、X.509証明書ベースのSPIFFE検証可能アイデンティティドキュメントです。このドキュメントでは、X.509-SVIDの形式、構造、使用方法について詳細に説明します。

## 目次

- [X.509 SVID](#x509-svid)
  - [このドキュメントの位置づけ](#このドキュメントの位置づけ)
  - [要約](#要約)
  - [目次](#目次)
  - [1. はじめに](#1-はじめに)
  - [2. X.509-SVIDの形式](#2-x509-svidの形式)
    - [2.1 X.509証明書](#21-x509証明書)
    - [2.2 SPIFFE IDの表現](#22-spiffe-idの表現)
    - [2.3 鍵ペア](#23-鍵ペア)
  - [3. X.509-SVIDの発行](#3-x509-svidの発行)
    - [3.1 発行プロセス](#31-発行プロセス)
    - [3.2 有効期限](#32-有効期限)
    - [3.3 更新](#33-更新)
  - [4. X.509-SVIDの検証](#4-x509-svidの検証)
    - [4.1 検証プロセス](#41-検証プロセス)
    - [4.2 トラストバンドル](#42-トラストバンドル)
  - [5. X.509-SVIDの使用方法](#5-x509-svidの使用方法)
    - [5.1 相互TLS（mTLS）](#51-相互tlsmtls)
    - [5.2 アクセス制御](#52-アクセス制御)
  - [6. セキュリティ考慮事項](#6-セキュリティ考慮事項)
  - [7. まとめ](#7-まとめ)

## 1. はじめに

X.509-SVIDは、SPIFFEフレームワークにおけるサービスアイデンティティの一形式です。X.509-SVIDは、X.509証明書を使用してサービスのSPIFFE IDを表現し、検証します。

X.509-SVIDは、TLS通信などのトランスポート層のセキュリティに使用されます。これにより、サービスは互いに認証し、安全に通信できます。

## 2. X.509-SVIDの形式

### 2.1 X.509証明書

X.509-SVIDは、X.509証明書として表現されます。この証明書は、以下の要件を満たす必要があります：

- X.509 v3証明書であること
- 適切な暗号アルゴリズムを使用していること
- 適切な鍵長を持つこと

X.509-SVIDは、証明書チェーンとして表現されることもあります。この場合、リーフ証明書がサービスのSPIFFE IDを表し、中間証明書がトラストチェーンを形成します。

### 2.2 SPIFFE IDの表現

X.509-SVIDでは、SPIFFE IDはX.509証明書のSubject Alternative Name（SAN）拡張フィールドのURI SANとして表現されます。URI SANは、以下の形式を持ちます：

```
spiffe://トラストドメイン/パス
```

X.509-SVIDは、1つ以上のSPIFFE IDを含むことができます。ただし、通常は1つのSPIFFE IDのみを含みます。

### 2.3 鍵ペア

X.509-SVIDは、公開鍵と秘密鍵のペアに関連付けられています。公開鍵は証明書に含まれ、秘密鍵はサービスによって安全に保管されます。

鍵ペアは、以下の目的で使用されます：

- サービスの認証
- 通信の暗号化
- デジタル署名

## 3. X.509-SVIDの発行

### 3.1 発行プロセス

X.509-SVIDは、以下のプロセスで発行されます：

1. サービスは、SPIFFE実装（例：SPIRE）に対して、X.509-SVIDの発行をリクエストします。
2. SPIFFE実装は、サービスのアイデンティティを検証します。
3. 検証が成功すると、SPIFFE実装は、サービスのSPIFFE IDを含むX.509証明書を生成します。
4. 生成された証明書と関連する秘密鍵がサービスに提供されます。

### 3.2 有効期限

X.509-SVIDには、有効期限があります。有効期限は、証明書のNotBeforeフィールドとNotAfterフィールドによって定義されます。

有効期限は、セキュリティ上の理由から比較的短く設定されることが一般的です（例：1時間から24時間）。これにより、漏洩した証明書の影響を最小限に抑えることができます。

### 3.3 更新

X.509-SVIDは、有効期限が切れる前に更新する必要があります。更新プロセスは、発行プロセスと同様ですが、既存のSVIDを使用して認証が行われます。

SPIFFE実装は、通常、SVIDの自動更新メカニズムを提供します。これにより、サービスは常に有効なSVIDを持つことができます。

## 4. X.509-SVIDの検証

### 4.1 検証プロセス

X.509-SVIDの検証は、以下のプロセスで行われます：

1. 証明書の有効期限を確認します。
2. 証明書の署名を、トラストバンドルの公開鍵を使用して検証します。
3. 証明書のURI SANからSPIFFE IDを抽出します。
4. 抽出されたSPIFFE IDが、期待されるSPIFFE IDと一致することを確認します。

検証が成功すると、サービスは通信相手のアイデンティティを信頼できます。

### 4.2 トラストバンドル

トラストバンドルは、X.509-SVIDの検証に使用される公開鍵のセットです。トラストバンドルは、トラストドメインごとに存在します。

サービスは、通信相手のSVIDを検証するために、そのSVIDのトラストドメインに対応するトラストバンドルを持っている必要があります。

## 5. X.509-SVIDの使用方法

### 5.1 相互TLS（mTLS）

X.509-SVIDの主な使用方法は、相互TLS（mTLS）通信です。mTLSでは、クライアントとサーバーの両方が証明書を使用して互いに認証します。

X.509-SVIDを使用したmTLSの手順は以下の通りです：

1. クライアントとサーバーは、それぞれのX.509-SVIDを取得します。
2. TLS接続が確立されると、クライアントとサーバーは互いの証明書を交換します。
3. 両方のサービスは、受け取った証明書を検証します。
4. 検証が成功すると、安全な通信チャネルが確立されます。

### 5.2 アクセス制御

X.509-SVIDは、アクセス制御の決定にも使用されます。サービスは、リクエスト元のSPIFFE IDに基づいて、リクエストを許可するかどうかを決定できます。

例えば、データベースサービスは、特定のSPIFFE IDを持つサービスからのリクエストのみを許可するポリシーを実装できます。

## 6. セキュリティ考慮事項

X.509-SVIDを使用する際には、以下のセキュリティ考慮事項に注意する必要があります：

- **秘密鍵の保護**: X.509-SVIDの秘密鍵は、安全に保管する必要があります。秘密鍵が漏洩すると、攻撃者がサービスになりすますことができます。
- **有効期限の管理**: X.509-SVIDの有効期限は適切に管理し、定期的に更新する必要があります。
- **トラストバンドルの整合性**: トラストバンドルは、改ざんから保護する必要があります。トラストバンドルが改ざんされると、不正なSVIDが検証される可能性があります。

## 7. まとめ

X.509-SVIDは、SPIFFEフレームワークにおけるサービスアイデンティティの一形式です。X.509-SVIDは、X.509証明書を使用してサービスのSPIFFE IDを表現し、検証します。

X.509-SVIDは、mTLS通信やアクセス制御など、さまざまな用途に使用されます。X.509-SVIDを適切に管理することで、サービス間の安全な通信とアクセス制御を実現できます。
