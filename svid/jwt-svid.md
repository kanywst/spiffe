# JWT SVID

## このドキュメントの位置づけ

このドキュメントは、JWT SPIFFE検証可能アイデンティティドキュメント（JWT-SVID）の標準をインターネットコミュニティ向けに規定し、改善のための議論と提案を求めるものです。このドキュメントの配布に制限はありません。

## 要約

JWT-SVIDは、JSON Web Token（JWT）ベースのSPIFFE検証可能アイデンティティドキュメントです。このドキュメントでは、JWT-SVIDの形式、構造、使用方法について詳細に説明します。

## 目次

- [JWT SVID](#jwt-svid)
  - [このドキュメントの位置づけ](#このドキュメントの位置づけ)
  - [要約](#要約)
  - [目次](#目次)
  - [1. はじめに](#1-はじめに)
  - [2. JWT-SVIDの形式](#2-jwt-svidの形式)
    - [2.1 JWTの構造](#21-jwtの構造)
    - [2.2 ヘッダー](#22-ヘッダー)
    - [2.3 ペイロード](#23-ペイロード)
    - [2.4 署名](#24-署名)
  - [3. JWT-SVIDの発行](#3-jwt-svidの発行)
    - [3.1 発行プロセス](#31-発行プロセス)
    - [3.2 有効期限](#32-有効期限)
    - [3.3 オーディエンス](#33-オーディエンス)
  - [4. JWT-SVIDの検証](#4-jwt-svidの検証)
    - [4.1 検証プロセス](#41-検証プロセス)
    - [4.2 JWKSバンドル](#42-jwksバンドル)
  - [5. JWT-SVIDの使用方法](#5-jwt-svidの使用方法)
    - [5.1 HTTPリクエスト認証](#51-httpリクエスト認証)
    - [5.2 アクセス制御](#52-アクセス制御)
  - [6. セキュリティ考慮事項](#6-セキュリティ考慮事項)
  - [7. まとめ](#7-まとめ)

## 1. はじめに

JWT-SVIDは、SPIFFEフレームワークにおけるサービスアイデンティティの一形式です。JWT-SVIDは、JSON Web Token（JWT）を使用してサービスのSPIFFE IDを表現し、検証します。

JWT-SVIDは、HTTPリクエストなどのアプリケーション層の認証に使用されます。これにより、サービスは互いに認証し、安全に通信できます。

## 2. JWT-SVIDの形式

### 2.1 JWTの構造

JWT-SVIDは、標準的なJWTの形式に従います。JWTは、以下の3つの部分からなるコンパクトな形式で表現されます：

```
ヘッダー.ペイロード.署名
```

各部分は、Base64URL形式でエンコードされ、ドット（.）で区切られます。

### 2.2 ヘッダー

JWTヘッダーは、トークンのタイプと使用する署名アルゴリズムを指定するJSONオブジェクトです。JWT-SVIDのヘッダーには、以下のフィールドが含まれます：

- **typ**: トークンのタイプ。通常は"JWT"。
- **alg**: 署名アルゴリズム。例えば、"RS256"（RSA署名、SHA-256ハッシュ）。
- **kid**: 鍵ID。署名に使用された鍵を識別するために使用されます。

例：
```json
{
  "typ": "JWT",
  "alg": "RS256",
  "kid": "key-id-1"
}
```

### 2.3 ペイロード

JWTペイロードは、クレームを含むJSONオブジェクトです。クレームは、エンティティ（通常はサービス）に関する情報と追加のメタデータです。JWT-SVIDのペイロードには、以下の標準クレームが含まれます：

- **sub**: サブジェクト。SPIFFE IDを表します。
- **iss**: 発行者。通常はトラストドメインを表します。
- **aud**: オーディエンス。トークンの意図された受信者を表します。
- **exp**: 有効期限。トークンが無効になる時間を表します。
- **iat**: 発行時間。トークンが発行された時間を表します。
- **nbf**: 有効開始時間。トークンが有効になる時間を表します。

例：
```json
{
  "sub": "spiffe://example.com/service/frontend",
  "iss": "spiffe://example.com",
  "aud": ["spiffe://example.com/service/backend"],
  "exp": 1625097600,
  "iat": 1625094000,
  "nbf": 1625094000
}
```

### 2.4 署名

JWT署名は、ヘッダーとペイロードの整合性と真正性を保証します。署名は、ヘッダーで指定されたアルゴリズムを使用して、エンコードされたヘッダーとエンコードされたペイロードから生成されます。

署名は、トラストドメインの秘密鍵を使用して生成されます。対応する公開鍵は、JWKSバンドルに含まれています。

## 3. JWT-SVIDの発行

### 3.1 発行プロセス

JWT-SVIDは、以下のプロセスで発行されます：

1. サービスは、SPIFFE実装（例：SPIRE）に対して、JWT-SVIDの発行をリクエストします。
2. SPIFFE実装は、サービスのアイデンティティを検証します。
3. 検証が成功すると、SPIFFE実装は、サービスのSPIFFE IDを含むJWTを生成します。
4. 生成されたJWTがサービスに提供されます。

### 3.2 有効期限

JWT-SVIDには、有効期限があります。有効期限は、ペイロードの`exp`クレームによって定義されます。

有効期限は、セキュリティ上の理由から比較的短く設定されることが一般的です（例：数分から数時間）。これにより、漏洩したトークンの影響を最小限に抑えることができます。

### 3.3 オーディエンス

JWT-SVIDには、オーディエンスが指定されています。オーディエンスは、ペイロードの`aud`クレームによって定義され、トークンの意図された受信者を表します。

オーディエンスは、通常、サービスのSPIFFE IDまたはURLです。サービスは、自身がオーディエンスとして指定されているJWT-SVIDのみを受け入れるべきです。

## 4. JWT-SVIDの検証

### 4.1 検証プロセス

JWT-SVIDの検証は、以下のプロセスで行われます：

1. JWTの形式が正しいことを確認します。
2. ヘッダーの`alg`フィールドが期待されるアルゴリズムであることを確認します。
3. ヘッダーの`kid`フィールドを使用して、JWKSバンドルから適切な公開鍵を取得します。
4. 取得した公開鍵を使用して、JWTの署名を検証します。
5. ペイロードの`exp`、`nbf`、`iat`クレームを確認して、トークンが有効期間内であることを確認します。
6. ペイロードの`aud`クレームを確認して、自身がオーディエンスとして指定されていることを確認します。
7. ペイロードの`sub`クレームからSPIFFE IDを抽出し、期待されるSPIFFE IDと一致することを確認します。

検証が成功すると、サービスはリクエスト元のアイデンティティを信頼できます。

### 4.2 JWKSバンドル

JWKSバンドルは、JWT-SVIDの検証に使用される公開鍵のセットです。JWKSバンドルは、JSON Web Key Set（JWKS）形式で表現されます。

JWKSバンドルは、トラストドメインごとに存在します。サービスは、リクエスト元のJWT-SVIDを検証するために、そのJWT-SVIDのトラストドメインに対応するJWKSバンドルを持っている必要があります。

## 5. JWT-SVIDの使用方法

### 5.1 HTTPリクエスト認証

JWT-SVIDの主な使用方法は、HTTPリクエストの認証です。サービスは、HTTPリクエストのAuthorizationヘッダーにJWT-SVIDを含めることで、自身のアイデンティティを証明します。

例：
```
Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6ImtleS1pZC0xIiwidHlwIjoiSldUIn0.eyJzdWIiOiJzcGlmZmU6Ly9leGFtcGxlLmNvbS9zZXJ2aWNlL2Zyb250ZW5kIiwiaXNzIjoic3BpZmZlOi8vZXhhbXBsZS5jb20iLCJhdWQiOlsic3BpZmZlOi8vZXhhbXBsZS5jb20vc2VydmljZS9iYWNrZW5kIl0sImV4cCI6MTYyNTA5NzYwMCwiaWF0IjoxNjI1MDk0MDAwLCJuYmYiOjE2MjUwOTQwMDB9.signature
```

### 5.2 アクセス制御

JWT-SVIDは、アクセス制御の決定にも使用されます。サービスは、リクエスト元のSPIFFE IDに基づいて、リクエストを許可するかどうかを決定できます。

例えば、バックエンドサービスは、特定のSPIFFE IDを持つフロントエンドサービスからのリクエストのみを許可するポリシーを実装できます。

## 6. セキュリティ考慮事項

JWT-SVIDを使用する際には、以下のセキュリティ考慮事項に注意する必要があります：

- **トークンの漏洩**: JWT-SVIDは、秘密情報として扱う必要があります。トークンが漏洩すると、攻撃者がサービスになりすますことができます。
- **有効期限の管理**: JWT-SVIDの有効期限は適切に管理し、短い有効期限を設定することが推奨されます。
- **オーディエンスの検証**: サービスは、自身がオーディエンスとして指定されているJWT-SVIDのみを受け入れるべきです。
- **JWKSバンドルの整合性**: JWKSバンドルは、改ざんから保護する必要があります。JWKSバンドルが改ざんされると、不正なJWT-SVIDが検証される可能性があります。

## 7. まとめ

JWT-SVIDは、SPIFFEフレームワークにおけるサービスアイデンティティの一形式です。JWT-SVIDは、JSON Web Token（JWT）を使用してサービスのSPIFFE IDを表現し、検証します。

JWT-SVIDは、HTTPリクエスト認証やアクセス制御など、さまざまな用途に使用されます。JWT-SVIDを適切に管理することで、サービス間の安全な通信とアクセス制御を実現できます。
